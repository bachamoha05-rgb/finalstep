<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Abysse</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@900&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --pixel-font: 'Press Start 2P', cursive; --modern-font: 'Poppins', sans-serif; }
        body { margin: 0; background: #000; color: #fff; font-family: var(--pixel-font); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; transition: background 2s ease; cursor: pointer; user-select: none; }
        #game-container { display: flex; flex-direction: column; align-items: center; transition: opacity 1s ease; }
        #word-display { font-size: 1.5rem; margin-bottom: 40px; letter-spacing: 10px; }
        input { background: transparent; border: 4px solid #fff; color: #fff; font-family: inherit; font-size: 1.5rem; width: 70px; text-align: center; padding: 15px; outline: none; text-transform: uppercase; margin-bottom: 20px; }
        #validate-btn { background: #fff; color: #000; border: none; padding: 12px 25px; font-family: var(--pixel-font); font-size: 0.7rem; cursor: pointer; }
        #cinematic-container { display: none; width: 90%; max-width: 800px; text-align: center; opacity: 0; transition: opacity 1s ease; }
        #scene { display: flex; justify-content: space-around; align-items: flex-end; height: 220px; margin-top: 20px; border-bottom: 2px solid #222; padding-bottom: 10px; }
        canvas { image-rendering: pixelated; transition: opacity 0.5s; }
        #dialogue-text { font-size: 0.65rem; line-height: 1.8; min-height: 100px; padding: 20px; background: rgba(255,255,255,0.05); margin-top: 20px; }
        #final-screen { display: none; position: fixed; inset: 0; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(-45deg, #121212, #1a1a1a, #000, #222); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: 100; }
        body.victory-bg #final-screen { background: linear-gradient(-45deg, #5865F2, #e73c7e, #23a6d5, #23d5ab); }
        .big-ismac { font-family: var(--modern-font); font-size: 4rem; background: rgba(255,255,255,0.15); padding: 20px 60px; border-radius: 100px; backdrop-filter: blur(15px); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #reset-btn { position: fixed; bottom: 5px; left: 5px; background: transparent; border: none; color: #050505; font-size: 0.3rem; z-index: 200; }
    </style>
</head>
<body onclick="handleInteraction()">

    <div id="game-container">
        <div id="word-display">_ _ _ _ _</div>
        <input type="text" id="letter-input" maxlength="1" placeholder="?" autocomplete="off">
        <button id="validate-btn">VALIDER</button>
        <div id="game-message" style="margin-top: 20px; font-size: 0.6rem; color: #ff4444; height: 20px;"></div>
    </div>

    <div id="cinematic-container">
        <div id="speaker" style="font-size: 0.5rem; color: #555; text-transform: uppercase; letter-spacing: 3px;"></div>
        <div id="scene">
            <canvas id="sharkCanvas"></canvas>
            <canvas id="crocoCanvas"></canvas>
        </div>
        <div id="dialogue-text"></div>
        <div style="font-size: 0.4rem; color: #333; margin-top: 10px;">( CLIQUE POUR CONTINUER )</div>
    </div>

    <div id="final-screen">
        <div style="font-family: var(--modern-font); font-weight: 800; margin-bottom: 20px; letter-spacing: 4px; opacity: 0.8;">PROJET TERMINÉ</div>
        <div class="big-ismac">ISMAC</div>
    </div>

    <button id="reset-btn" onclick="adminReset()">RESET</button>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCLUNQhx8h0dHmiI3rqJ6QPuDju0Aa4zAo", authDomain: "trailer-90acb.firebaseapp.com", databaseURL: "https://trailer-90acb-default-rtdb.firebaseio.com", projectId: "trailer-90acb", storageBucket: "trailer-90acb.firebasestorage.app", messagingSenderId: "216077694665", appId: "1:216077694665:web:e6090a278b656f7d2f7f18" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const SECRET_WORD = "ISMAC";

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTypeSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(110, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.02, audioCtx.currentTime); osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.03);
        }

        function drawToCanvas(canvasId, spriteStr, width, height, pSize) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const lines = spriteStr.trim().split('\n');
            canvas.width = width * pSize; canvas.height = height * pSize;
            ctx.fillStyle = "#FFF";
            lines.forEach((line, y) => {
                [...line].forEach((char, x) => {
                    if(char === '0') ctx.fillRect(x * pSize, y * pSize, pSize, pSize);
                });
            });
        }

        const crocoData = `111111111111111111111111111111111111
111111111111111111111111111111111111
111111111111000000001111111111111111
111111111111000000001111111111111111
111111111111000000001111111111111111
111111111111000000001111111111111111
111111111110000000000011111111111111
111111000000000000000000001111111111
111111000000000000000000001111111111
111111000000000000000000001111111111
111111000000000000000000001111111111
111111000000000000000000001111111111
111111111100000000000001111111111111
111111111100000000000001111111111111
111111111100000000000001111111111111
111111111100000000000001111111111111
111111111110000000000000111111111111
111111111110000000000000000111111111
111111111111000000000000000111111111
111111111100000000000000000000111111
111111111000000000000000000000111111
111111111000000000000000000000111111
111111111000000000000000100000111111
111111111000000000000000100000111111
111111111000000000000000100001111111
111111111000000000000000100000111111
111111111000000000000000100000111111
111111111000000000000000100000111111
111111111100000000000001100001111111
111111111111000011000001111111111111
111111111111000011000001111111111111
111111111110000011000001111111111111
111111111110000011000001111111111111
111111111110000011000001111111111111
111111111110000011000001111111111111
111111111100000000000001111111111111
111111111100000000000001111111111111
111111111100000000000001111111111111
111111111111111111111111111111111111
111111111111111111111111111111111111`;

        const sharkData = `1111111111111111111111111111111
1111111111111111111111111111111
1111111111000001111111111111111
1111111111000001111111111111111
1111111111000000000000011111111
1111111111000001011011111111111
1111111111000001111111111111110
1111111111000001111101111111110
1111111111000000000001111110011
1111111110000011111111111001111
1111111110000001111111101111111
1111111110000000000011101111111
1111111110000000001000111111111
1111111110000000001111111111111
1111111110000000001111111111111
1111111110000010001111111111111
1111111100000010001111111111111
1111111100000010000001111111111
1111111111111110000001111111111`;

        drawToCanvas('crocoCanvas', crocoData, 36, 40, 4);
        drawToCanvas('sharkCanvas', sharkData, 31, 19, 6);

        const script = [
            {n:"gamemaster",t:"Hey"},
            {n:"son frère",t:"?"},
            {n:"gamemaster",t:"Ils ont enfin réussi les 5 épreuves."},
            {n:"son frère",t:"Ah ouais ? Ils en ont mis du temps dis donc."},
            {n:"gamemaster",t:"Faut pas leur en vouloir, au moins ils auront appris des choses du genre :"},
            {n:"gamemaster",t:"Qu’il faut cliquer sur des robots pour les éliminer, que 1+1 = 2..."},
            {n:"gamemaster",t:"Ou bien qu’on peut survivre avec un lobe frontal en moins."},
            {n:"son frère",t:"Un lobe frontal… en moins… ? Qu’est ce que c’est que ces conneries ?"},
            {n:"gamemaster",t:"Bref… Avec du boulot on peut tout avoir"},
            {n:"son frère",t:"Mais au finale on ne repartira avec rien."},
            {n:"gamemaster",t:"Certes, mais je vais leur donner un p’tit cadeau qu'ils garderont toute leurs vie : ISMAC."}
        ];

        let phase = "game"; let currentLine = -1; let isTyping = false; let solved = false;

        db.ref("mot").on("value", snap => {
            const data = snap.val() || {}; let count = 0;
            for(let i=0;i<5;i++) if(data[i]) count++;
            document.getElementById('word-display').innerText = SECRET_WORD.split('').map((c,i)=>data[i]?c:'_').join(' ');
            if(count===5 && !solved) { solved=true; setTimeout(startCinematic, 1000); }
        });

        function handleInteraction() { if(phase==="cinema" && !isTyping) nextLine(); }
        function startCinematic() {
            phase = "cinema";
            document.getElementById('game-container').style.opacity = "0";
            setTimeout(() => {
                document.getElementById('game-container').style.display = "none";
                const cin = document.getElementById('cinematic-container');
                cin.style.display = "block";
                setTimeout(() => cin.style.opacity = "1", 100);
                nextLine();
            }, 1000);
        }

        function nextLine() {
            currentLine++;
            if(currentLine < script.length) {
                const l = script[currentLine];
                document.getElementById('speaker').textContent = l.n;
                document.getElementById('crocoCanvas').style.opacity = (l.n==="gamemaster")?1:0.2;
                document.getElementById('sharkCanvas').style.opacity = (l.n==="son frère")?1:0.2;
                typeW(l.t);
            } else { showFinal(); }
        }

        function typeW(text) {
            isTyping = true; let i = 0; const el = document.getElementById('dialogue-text'); el.textContent = "";
            const itv = setInterval(() => { el.textContent += text[i]; playTypeSound(); i++; if(i>=text.length) { clearInterval(itv); isTyping=false; } }, 45);
        }

        function showFinal() {
            phase = "final"; document.getElementById('cinematic-container').style.opacity = "0";
            setTimeout(() => { document.body.classList.add('victory-bg'); document.getElementById('final-screen').style.display = "flex"; }, 1000);
        }

        const validate = () => {
            if(localStorage.getItem('hasContributed')) return;
            const inp = document.getElementById('letter-input'); const char = inp.value.toUpperCase();
            if(SECRET_WORD.includes(char)) { 
                for(let i=0;i<5;i++) if(SECRET_WORD[i]===char) db.ref("mot/"+i).set(true); 
                localStorage.setItem('hasContributed','true'); inp.disabled=true; 
            } else {
                document.getElementById('game-message').innerText="ERREUR"; 
                inp.value=""; setTimeout(() => document.getElementById('game-message').innerText="", 1500);
            }
        };
        document.getElementById('validate-btn').onclick = validate;
        function adminReset() { if(confirm("Reset?")) { db.ref("mot").remove(); localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
