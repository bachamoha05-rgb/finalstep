<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>L'Abysse | ISMAC Project</title>
    <meta name="description" content="Une expérience interactive mystérieuse. Récupérez le cadeau.">
    <meta property="og:title" content="L'Abysse - ISMAC">
    <meta property="og:description" content="Saurez-vous décoder le message des profondeurs ?">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@900&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --pixel-font: 'Press Start 2P', cursive; 
            --modern-font: 'Poppins', sans-serif; 
            --bg-color: #000;
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            background: var(--bg-color); 
            color: #fff; 
            font-family: var(--pixel-font); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden; 
            transition: background 2s ease; 
            cursor: pointer;
            user-select: none;
        }

        /* --- ÉCRAN DE JEU (PHASE 1) --- */
        #game-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            transition: opacity 1s ease, transform 1s ease; 
        }

        #word-display { 
            font-size: clamp(1rem, 5vw, 1.8rem); 
            margin-bottom: 40px; 
            letter-spacing: 10px; 
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        input { 
            background: transparent; 
            border: 4px solid #fff; 
            color: #fff; 
            font-family: inherit; 
            font-size: 1.5rem; 
            width: 70px; 
            text-align: center; 
            padding: 15px; 
            outline: none; 
            text-transform: uppercase; 
            margin-bottom: 20px; 
            transition: border-color 0.3s;
        }

        input:focus { border-color: #00ffff; }

        #validate-btn { 
            background: #fff; 
            color: #000; 
            border: none; 
            padding: 12px 25px; 
            font-family: var(--pixel-font); 
            font-size: 0.7rem; 
            cursor: pointer; 
            box-shadow: 4px 4px 0px #555;
        }

        #validate-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #555; }
        #validate-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* --- CINÉMATIQUE (PHASE 2) --- */
        #cinematic-container { 
            display: none; 
            width: 90%; 
            max-width: 800px; 
            text-align: center; 
            opacity: 0; 
            transition: opacity 1s ease; 
        }

        #scene { 
            display: flex; 
            justify-content: space-around; 
            align-items: flex-end; 
            height: 250px; 
            margin-top: 20px;
            border-bottom: 2px solid #222;
            padding-bottom: 10px;
        }

        canvas { image-rendering: pixelated; transition: opacity 0.5s; }

        #dialogue-text { 
            font-size: clamp(0.5rem, 3vw, 0.7rem); 
            line-height: 1.8; 
            min-height: 100px; 
            padding: 20px; 
            background: rgba(255,255,255,0.05);
            margin-top: 20px;
        }

        /* --- FINAL (PHASE 3) --- */
        #final-screen { 
            display: none; 
            position: fixed; 
            inset: 0; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(-45deg, #121212, #1a1a1a, #000, #222);
            background-size: 400% 400%; 
            animation: gradientBG 15s ease infinite; 
            z-index: 100; 
        }

        body.victory-bg #final-screen {
            background: linear-gradient(-45deg, #5865F2, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
        }

        .big-ismac { 
            font-family: var(--modern-font); 
            font-size: clamp(3rem, 15vw, 6rem); 
            background: rgba(255,255,255,0.15); 
            padding: 20px 60px; 
            border-radius: 100px; 
            backdrop-filter: blur(15px); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            letter-spacing: -2px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Reset discret */
        #reset-btn { position: fixed; bottom: 5px; left: 5px; background: transparent; border: none; color: #050505; font-size: 0.3rem; z-index: 200; cursor: default; }
    </style>
</head>
<body onclick="handleInteraction()">

    <div id="game-container">
        <div id="word-display">_ _ _ _ _</div>
        <input type="text" id="letter-input" maxlength="1" placeholder="?" autocomplete="off">
        <button id="validate-btn">VALIDER</button>
        <div id="game-message" style="margin-top: 20px; font-size: 0.6rem; color: #ff4444; height: 20px;"></div>
    </div>

    <div id="cinematic-container">
        <div id="speaker" style="font-size: 0.5rem; color: #555; text-transform: uppercase; letter-spacing: 3px;"></div>
        <div id="scene">
            <canvas id="crocoCanvas"></canvas>
            <canvas id="sharkCanvas"></canvas>
        </div>
        <div id="dialogue-text"></div>
        <div style="font-size: 0.4rem; color: #333; margin-top: 10px;">( CLIQUE POUR CONTINUER )</div>
    </div>

    <div id="final-screen">
        <div style="font-family: var(--modern-font); font-weight: 800; margin-bottom: 20px; letter-spacing: 4px; opacity: 0.8;">PROJET TERMINÉ</div>
        <div class="big-ismac">ISMAC</div>
    </div>

    <button id="reset-btn" onclick="adminReset()"></button>

    <script>
        // --- CONFIGURATION FIREBASE ---
        const firebaseConfig = { 
            apiKey: "AIzaSyCLUNQhx8h0dHmiI3rqJ6QPuDju0Aa4zAo", 
            authDomain: "trailer-90acb.firebaseapp.com", 
            databaseURL: "https://trailer-90acb-default-rtdb.firebaseio.com", 
            projectId: "trailer-90acb", 
            storageBucket: "trailer-90acb.firebasestorage.app", 
            messagingSenderId: "216077694665", 
            appId: "1:216077694665:web:e6090a278b656f7d2f7f18" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const SECRET_WORD = "ISMAC";

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTypeSound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(100 + Math.random() * 50, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.03, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.04);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.04);
        }

        // --- SPRITES CANVAS ---
        function drawToCanvas(canvasId, spriteStr, width, height, pSize) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const sprite = spriteStr.split(',').map(r => r.split('').map(Number));
            canvas.width = width * pSize; canvas.height = height * pSize;
            ctx.fillStyle = "#FFF";
            for(let y=0; y<height; y++) {
                for(let x=0; x<width; x++) {
                    if(sprite[y][x] === 0) ctx.fillRect(x*pSize, y*pSize, pSize, pSize);
                }
            }
        }

        const crocoData = `111111111111111111111111111111111111,111111111111111111111111111111111111,111111111111000000001111111111111111,111111111111000000001111111111111111,111111111111000000001111111111111111,111111111111000000001111111111111111,111111111110000000000011111111111111,111111000000000000000000001111111111,111111000000000000000000001111111111,111111000000000000000000001111111111,111111000000000000000000001111111111,111111000000000000000000001111111111,111111111100000000000001111111111111,111111111100000000000001111111111111,111111111100000000000001111111111111,111111111100000000000001111111111111,111111111110000000000000111111111111,111111111110000000000000000111111111,111111111111000000000000000111111111,111111111100000000000000000000111111,111111111000000000000000000000111111,111111111000000000000000000000111111,111111111000000000000000100000111111,111111111000000000000000100000111111,111111111000000000000000100001111111,111111111000000000000000100000111111,111111111000000000000000100000111111,111111111000000000000000100000111111,111111111100000000000001100001111111,111111111111000011000001111111111111,111111111111000011000001111111111111,111111111110000011000001111111111111,111111111110000011000001111111111111,111111111110000011000001111111111111,111111111110000011000001111111111111,111111111100000000000001111111111111,111111111100000000000001111111111111,111111111100000000000001111111111111,111111111111111111111111111111111111,111111111111111111111111111111111111`;
        const sharkData = `1111111111111111111111111111111111111111,1111111111111111111111111111111111111111,1111111111111111111111111111111101111111,1111111111111111111111111111111111111111,1111111111111111111111111111111111111111,1111111111111111111111111111111111111111,1111111111111111111111111111111111111111,1111111111111111111111111111111111111111,1111111110011111111111101111111111111111,1111111110000001111111111111111111111111,1111111110011111111101111111111111111111,1111111110011111111111111111111111111111,1111111110011111111111111111111111111111,1111111100011111111111111111111111111111,1111111100001101111111111111111111111111,1111111100001111111111111111111111111111,1111111111111111111111111111111111111111,1111111111100011111111111111111111111111,1111111111111111111111111111111111111111,1111111111111111111111111111111111111111`;

        drawToCanvas('crocoCanvas', crocoData, 36, 40, 4);
        drawToCanvas('sharkCanvas', sharkData, 40, 20, 5); // Un peu plus grand pour l'équilibre

        // --- LOGIQUE GÉNÉRALE ---
        const script = [
            {n:"crocodile",t:"Hey"},
            {n:"requin",t:"?"},
            {n:"crocodile",t:"Ils ont enfin réussi les 5 épreuves"},
            {n:"requin",t:"Ah ouais ? Ils en ont mis du temps dis donc"},
            {n:"crocodile",t:"Faut pas leur en vouloir, au moins ils auront appris des choses du genre :"},
            {n:"crocodile",t:"Qu’il faut cliquer sur des robots pour les éliminer, que 1+1 = 2..."},
            {n:"crocodile",t:"Ou bien qu’on peut survivre avec un lobe frontal en moins."},
            {n:"requin",t:"Un lobe frontal… en moins… ? Qu’est ce que c’est que ces conneries ?"},
            {n:"crocodile",t:"Bref… Avec du boulot on peut tout avoir"},
            {n:"requin",t:"Et on repartira avec rien"},
            {n:"crocodile",t:"Certes, mais je vais leur donner un p’tit cadeau : ISMAC"}
        ];

        let phase = "game"; let currentLine = -1; let isTyping = false; let solved = false;

        // Écoute Firebase
        db.ref("mot").on("value", snap => {
            const data = snap.val() || {}; let disp = ""; let count = 0;
            for(let i=0;i<5;i++) { 
                if(data[i]) { disp+=SECRET_WORD[i]+" "; count++; } 
                else disp+="_ "; 
            }
            document.getElementById('word-display').innerText = disp.trim();
            if(count===5 && !solved) { 
                solved=true; 
                setTimeout(startCinematic, 1000); 
            }
        });

        function handleInteraction() { 
            if(phase==="cinema" && !isTyping) nextLine(); 
        }

        function startCinematic() {
            phase = "cinema";
            document.getElementById('game-container').style.transform = "translateY(-20px)";
            document.getElementById('game-container').style.opacity = "0";
            setTimeout(() => {
                document.getElementById('game-container').style.display = "none";
                const cin = document.getElementById('cinematic-container');
                cin.style.display = "block";
                setTimeout(() => cin.style.opacity = "1", 100);
                nextLine();
            }, 1000);
        }

        function nextLine() {
            currentLine++;
            if(currentLine < script.length) {
                const l = script[currentLine];
                document.getElementById('speaker').textContent = l.n;
                document.getElementById('crocoCanvas').style.opacity = (l.n==="crocodile")?1:0.2;
                document.getElementById('sharkCanvas').style.opacity = (l.n==="requin")?1:0.2;
                typeW(l.t);
            } else {
                showFinal();
            }
        }

        function typeW(text) {
            isTyping = true;
            let i = 0;
            const el = document.getElementById('dialogue-text');
            el.textContent = "";
            const itv = setInterval(() => {
                el.textContent += text[i];
                playTypeSound();
                i++;
                if(i>=text.length) { clearInterval(itv); isTyping=false; }
            }, 45);
        }

        function showFinal() {
            phase = "final";
            document.getElementById('cinematic-container').style.opacity = "0";
            setTimeout(() => {
                document.body.classList.add('victory-bg');
                document.getElementById('final-screen').style.display = "flex";
            }, 1000);
        }

        // Validation
        const validate = () => {
            if(localStorage.getItem('hasContributed')) return;
            const inp = document.getElementById('letter-input'); 
            const char = inp.value.toUpperCase();
            if(SECRET_WORD.includes(char)) { 
                for(let i=0;i<5;i++) if(SECRET_WORD[i]===char) db.ref("mot/"+i).set(true); 
                localStorage.setItem('hasContributed','true'); 
                inp.disabled=true; 
                document.getElementById('validate-btn').disabled=true;
                document.getElementById('game-message').style.color = "#00ff00";
                document.getElementById('game-message').innerText = "SYNCHRONISATION...";
            } else {
                document.getElementById('game-message').innerText="ERREUR DE FRÉQUENCE";
                inp.value="";
                setTimeout(() => document.getElementById('game-message').innerText="", 1500);
            }
        };

        document.getElementById('validate-btn').onclick = validate;
        document.getElementById('letter-input').onkeyup = (e) => { if(e.key === "Enter") validate(); };

        function adminReset() { if(confirm("Réinitialiser l'expérience ?")) { db.ref("mot").remove(); localStorage.clear(); location.reload(); } }
        
        // Check local storage au démarrage
        if(localStorage.getItem('hasContributed')) { 
            document.getElementById('letter-input').disabled=true; 
            document.getElementById('validate-btn').disabled=true;
            document.getElementById('letter-input').placeholder = "✔";
        }
    </script>
</body>
</html>